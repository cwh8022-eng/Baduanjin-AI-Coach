<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Baduanjin AI Coach â€” Camera Only (One-Shot 100)</title>

  <!-- èˆ‡ Teachable Machine Pose æœ€ç›¸å®¹çš„ç‰ˆæœ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

  <style>
    :root { --w: 980px; }
    body { font-family: Arial,"Noto Sans TC",system-ui; background:#f3f5f8; padding:22px 14px 40px; color:#111827; }
    h1 { text-align:center; margin:0 0 6px; font-weight:800 }
    .hint { text-align:center; color:#6b7280; margin:4px 0 14px }

    .wrap { width:min(var(--w),96vw); margin:0 auto }
    .row-btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:10px 0 14px }
    button { padding:10px 16px; border:0; border-radius:10px; background:#0ea5e9; color:#fff; cursor:pointer; font-size:16px; box-shadow:0 4px 14px rgba(14,165,233,.2) }
    button:hover { filter:brightness(1.05) }

    .stage { display:grid; grid-template-columns: 460px 1fr; gap:18px; align-items:flex-start }
    @media (max-width:1020px){ .stage{ grid-template-columns: 1fr } }

    canvas { width:min(440px,96vw); height:auto; border-radius:12px; border:2px solid #334155; background:#000 }

    .score { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; margin-bottom:12px; display:flex; gap:14px; flex-wrap:wrap; align-items:center }
    .pill { background:#eef2ff; color:#3730a3; padding:6px 10px; border-radius:999px; font-weight:800 }
    .pill strong{ font-variant-numeric: tabular-nums }
    .cfg { color:#6b7280; font-size:14px }
    .cfg input { width:64px; padding:4px 6px; border-radius:8px; border:1px solid #cbd5e1; margin-left:4px }

    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px }
    .title { font-size:14px; color:#6b7280; margin:0 0 8px }
    .row { display:grid; grid-template-columns: 190px 1fr; gap:12px; align-items:center; margin:10px 0 }
    .name { font-weight:700; color:#374151; display:flex; align-items:center; gap:8px }
    .chips { display:inline-flex; gap:6px; margin-left:6px }
    .chip { background:#e2e8f0; color:#0f172a; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .track { position:relative; background:#e5e7eb; border-radius:999px; overflow:hidden; height:22px; box-shadow: inset 0 1px 1px rgba(0,0,0,.06) }
    .bar { height:100%; width:0%; background:linear-gradient(90deg,#34d399,#10b981); color:#fff; line-height:22px; text-align:right; padding-right:8px; font-size:12px; font-weight:700; transition:width .12s linear }
    .cls { position:absolute; right:8px; top:-18px; font-size:11px; color:#6b7280 }
    .flash { animation:flash .5s ease }
    @keyframes flash{ from{ box-shadow:0 0 0 0 rgba(16,185,129,.8)} to{ box-shadow:0 0 0 12px rgba(16,185,129,0)}}

    #msg{white-space:pre-line;font-weight:800;text-align:center;margin:8px 0 12px}
    .ok{ color:#065f46 } .bad{ color:#c0392b }
  </style>
</head>
<body>
  <h1>Baduanjin AI Coach (Camera)</h1>
  <div class="hint">ç›¸æ©Ÿè¾¨è­˜ â€¢ One-shotï¼šæ¯å¼åšå°ä¸€æ¬¡=100åˆ†ï¼›ç¸½åˆ†=å…«å¼å¹³å‡ã€‚è«‹ä½¿ç”¨ HTTPS ç¶²å€ä¸¦å…è¨±ç›¸æ©Ÿã€‚</div>

  <div class="wrap">
    <div class="row-btns">
      <button id="btnCam">ğŸ“· é–‹å§‹ç›¸æ©Ÿ</button>
      <button id="btnStop" disabled>â¹ åœæ­¢ç›¸æ©Ÿ</button>
      <button id="btnReset">ğŸ§¹ é‡ç½®è©•åˆ†</button>
    </div>

    <div class="score">
      <div class="pill">ç¸½åˆ†ï¼ˆå¹³å‡ï¼‰ï¼š<strong id="totalScore">0</strong></div>
      <div class="pill">æ™‚é–“ï¼š<strong id="timer">00:00</strong></div>
      <div class="pill">ç•¶å‰ï¼š<strong id="currentMove">â€”</strong></div>
      <div class="cfg">
        é–€æª»<input id="thres" type="number" step="0.05" min="0.5" max="0.95" value="0.80">
        ç¶­æŒç§’<input id="hold"  type="number" step="0.5" min="0.5" max="5"   value="2">
        å†·å»ç§’<input id="cool"  type="number" step="0.1" min="0.2" max="3"   value="0.8">
      </div>
    </div>

    <div id="msg" class="bad"></div>

    <div class="stage">
      <canvas id="view" width="400" height="400"></canvas>

      <div class="panel">
        <p class="title">å³æ™‚è¾¨è­˜ï¼ˆå›ºå®šå…«å¼é †åºï¼‰</p>
        <div id="bars"></div>
      </div>
    </div>
  </div>

<script>
(async function(){
  // ========== å…«å¼ & å°æ‡‰ ==========
  const TARGETS = [
    { key:'D1', name:'é›™æ‰‹æ‰˜å¤©ç†ä¸‰ç„¦' },
    { key:'D2', name:'å·¦å³é–‹å¼“ä¼¼å°„éµ°' },
    { key:'D3', name:'èª¿ç†è„¾èƒƒé ˆå–®èˆ‰' },
    { key:'D4', name:'äº”å‹ä¸ƒå‚·å¾€å¾Œç§' },
    { key:'D5', name:'æ–é ­æ“ºå°¾å»å¿ƒç«' },
    { key:'D6', name:'å…©æ‰‹æ”€è¶³å›ºè…è…°' },
    { key:'D7', name:'æ”¢æ‹³æ€’ç›®å¢æ°£åŠ›' },
    { key:'D8', name:'èƒŒå¾Œä¸ƒé¡›ç™¾ç—…æ¶ˆ' }
  ];
  const MAP_RULES = [
    { token:'é›™æ‰‹æ‰˜å¤©', k:'D1' }, { token:'æ‰˜å¤©', k:'D1' },
    { token:'é–‹å¼“', k:'D2' }, { token:'å°„é›•', k:'D2' }, { token:'å°„éµ°', k:'D2' },
    { token:'å–®èˆ‰', k:'D3' }, { token:'è„¾èƒƒ', k:'D3' },
    { token:'å¾€å¾Œç§', k:'D4' }, { token:'ä¸ƒå‚·', k:'D4' },
    { token:'æ“ºå°¾', k:'D5' }, { token:'å»å¿ƒç«', k:'D5' },
    { token:'æ”€è¶³', k:'D6' }, { token:'è…è…°', k:'D6' },
    { token:'æ”¢æ‹³', k:'D7' }, { token:'å¢æ°£åŠ›', k:'D7' },
    { token:'ä¸ƒé¡›', k:'D8' }, { token:'ç™¾ç—…æ¶ˆ', k:'D8' }
  ];
  const norm = s => (s||'').replace(/\s+/g,'').replace(/æ­£ç¢º/g,'').replace(/[()ï¼ˆï¼‰\[\]ã€ã€‘ï¼š:ï¼Œ,ã€‚.\-_/]/g,'').replace(/é›•/g,'éµ°').toLowerCase();

  // ========== åƒæ•¸ ==========
  const modelURL = './model.json';
  const metadataURL = './metadata.json';
  const SIZE = 400;
  const EMA_ALPHA = 0.35;   // æŒ‡æ•¸å¹³æ»‘
  const WINDOW = 12;        // æ»‘å‹•è¦–çª—å¹€æ•¸
  const MARGIN = 0.20;      // Top1-Top2 å·®è·æœ€å°å€¼
  const FALLBACK_THRESH = 0.80;

  // ========== DOM ==========
  const cv = document.getElementById('view');
  const ctx = cv.getContext('2d');
  const btnCam = document.getElementById('btnCam');
  const btnStop = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const barsEl = document.getElementById('bars');
  const $ = id=>document.getElementById(id);
  const pad2 = n=> n.toString().padStart(2,'0');
  const fmt = s=> `${pad2((s/60)|0)}:${pad2((s%60)|0)}`;

  // ========== ç‹€æ…‹ ==========
  let model, indexMap=null, classNames=[];
  let webcam=null, running=false, rafId=0, timerId=0, sessionStart=0;

  let smooth={}, ring=[], done={}, score={}, totalAvg=0;
  let currentKey=null, holdStart=0, holdSum=0, holdFrames=0, cooldownUntil=0;

  // ========== UI ==========
  function info(text, ok=false){ const m=$('msg'); m.className = ok?'ok':'bad'; m.textContent = text; }
  function flashRow(key){ const r=$('row-'+key); if(!r) return; r.classList.remove('flash'); void r.offsetWidth; r.classList.add('flash'); }
  function buildBars(labels){
    barsEl.innerHTML='';
    TARGETS.forEach((t,i)=>{
      const row = document.createElement('div'); row.className='row'; row.id=`row-${t.key}`;
      const name = document.createElement('div'); name.className='name';
      name.innerHTML = `${i+1}. ${t.name} <span class="chips"><span class="chip" id="status-${t.key}">æœªå®Œæˆ</span><span class="chip" id="sc-${t.key}">0</span></span>`;
      const track = document.createElement('div'); track.className='track';
      const bar = document.createElement('div'); bar.className='bar'; bar.id=`bar-${t.key}`; bar.textContent='0.0%';
      const cls = document.createElement('div'); cls.className='cls'; cls.id=`cls-${t.key}`;
      cls.textContent = (labels && labels[i]) ? labels[i] : 'ï¼ˆç­‰å¾…æ¨¡å‹â€¦ï¼‰';
      track.appendChild(bar); track.appendChild(cls);
      row.appendChild(name); row.appendChild(track);
      barsEl.appendChild(row);
    });
  }
  buildBars([]);

  function resetScores(){
    smooth = Object.fromEntries(TARGETS.map(t=>[t.key,0]));
    ring   = [];
    done   = Object.fromEntries(TARGETS.map(t=>[t.key,false]));
    score  = Object.fromEntries(TARGETS.map(t=>[t.key,0]));
    totalAvg = 0;
    TARGETS.forEach(t=>{
      $('status-'+t.key).textContent = 'æœªå®Œæˆ';
      $('sc-'+t.key).textContent = '0';
      const row = $('row-'+t.key); row && row.classList.remove('flash');
      const bar = $('bar-'+t.key); if(bar){ bar.style.width='0%'; bar.textContent='0.0%'; }
    });
    $('totalScore').textContent = '0';
    $('currentMove').textContent = 'â€”';
  }
  function recalcTotal(){
    const sum = TARGETS.reduce((s,t)=> s + (score[t.key]||0), 0);
    totalAvg = Math.round(sum / TARGETS.length);
    $('totalScore').textContent = totalAvg;
  }

  function buildIndexMap(labels){
    const map={}; TARGETS.forEach(t=>map[t.key]=-1);
    labels.forEach((name, idx)=>{
      const n = norm(name);
      for(const r of MAP_RULES){ if(n.includes(r.token) && map[r.k]===-1){ map[r.k]=idx; break; } }
      for(let i=1;i<=8;i++){ if(map['D'+i]===-1 && n.includes('d'+i)) map['D'+i]=idx; }
    });
    return map;
  }

  async function ensureModel(){
    if (model) return;
    model = await tmPose.load(modelURL, metadataURL);
    let labels=[];
    try{
      const meta = await fetch(metadataURL,{cache:'no-store'}).then(r=>r.json());
      const raw  = meta.labels || meta.classes || [];
      labels = raw.map(x => (x && x.label) ? x.label : (typeof x==='string' ? x : ''));
    }catch(_){}
    indexMap = buildIndexMap(labels);
    classNames = labels.slice();
    TARGETS.forEach((t,i)=>{
      const cls = $('cls-'+t.key);
      if(cls){ const idx = indexMap[t.key]; cls.textContent = (idx>=0 && classNames[idx]) ? classNames[idx] : '(æœªå°æ‡‰)'; }
    });
    resetScores();
  }

  // ========== ç›¸æ©Ÿæ§åˆ¶ ==========
  btnCam.onclick = async ()=>{
    try{
      if(!window.isSecureContext) throw new Error('éœ€è¦é€é HTTPS æˆ– localhost é–‹å•Ÿé é¢ï¼Œç€è¦½å™¨æ‰å…è¨±ç›¸æ©Ÿã€‚');
      await ensureModel();

      if(webcam){ await webcam.stop(); webcam=null; }
      webcam = new tmPose.Webcam(SIZE, SIZE, /*flip*/ true); // é¡åƒï¼ˆä½¿ç”¨è€…è¦–è§’ï¼‰
      await webcam.setup();
      await webcam.play();

      cv.width = SIZE; cv.height = SIZE;
      running = true; sessionStart = performance.now();
      btnCam.disabled = true; btnStop.disabled = false;

      tickTimer();
      loop();
      info('âœ… ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹æŠŠå…¨èº«å…¥é¡ï¼ˆå«è…³è¸èˆ‡é ­é ‚ï¼‰ã€‚', true);
    }catch(e){
      info('âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š\n' + (e.message || e));
    }
  };

  btnStop.onclick = async ()=>{
    try{
      running = false;
      cancelAnimationFrame(rafId);
      cancelAnimationFrame(timerId);
      if(webcam){ await webcam.stop(); webcam=null; }
      btnCam.disabled = false; btnStop.disabled = true;
      info('å·²åœæ­¢ç›¸æ©Ÿã€‚', true);
    }catch(e){ info('åœæ­¢ç›¸æ©Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š'+(e.message||e)); }
  };

  btnReset.onclick = ()=>{ resetScores(); info('å·²é‡ç½®è©•åˆ†', true); };

  function tickTimer(){
    if(!running) return;
    const sec = Math.max(0, Math.round((performance.now()-sessionStart)/1000));
    document.getElementById('timer').textContent = fmt(sec);
    timerId = requestAnimationFrame(tickTimer);
  }

  async function loop(){
    if(!running || !webcam) return;
    webcam.update();
    await stepWithSource(webcam.canvas); // ä½¿ç”¨ tmPose.Webcam ç”Ÿæˆçš„ 400Ã—400 ç•«å¸ƒä½œç‚ºä¾†æº
    rafId = requestAnimationFrame(loop);
  }

  // ========== æ¨è«–èˆ‡ç©©å®šåŒ– ==========
  async function stepWithSource(sourceCanvas){
    const { pose, posenetOutput } = await model.estimatePose(sourceCanvas);
    const preds = await model.predict(posenetOutput);

    // é¡¯ç¤ºç•«é¢ï¼ˆæŠŠä¾†æºç•«åˆ°é¡¯ç¤ºç”¨ç•«å¸ƒï¼‰+ éª¨æ¶ï¼ˆåº§æ¨™ä¸€è‡´ï¼Œä¸æœƒé£„ï¼‰
    ctx.drawImage(sourceCanvas, 0, 0, cv.width, cv.height);
    if(pose){ tmPose.drawKeypoints(pose.keypoints, 0.5, ctx); tmPose.drawSkeleton(pose.keypoints, 0.5, ctx); }

    // å– 8 é¡æ©Ÿç‡
    const rawProb = {};
    TARGETS.forEach(t=>{
      const idx = indexMap ? indexMap[t.key] : -1;
      rawProb[t.key] = (idx>=0 && preds[idx]) ? (preds[idx].probability || 0) : 0;
    });

    // 1) å–®å¹€ EMA å¹³æ»‘
    TARGETS.forEach(t=>{
      const v = rawProb[t.key];
      if(!(t.key in smooth)) smooth[t.key]=0;
      smooth[t.key] = EMA_ALPHA*v + (1-EMA_ALPHA)*smooth[t.key];
    });

    // 2) æ»‘å‹•è¦–çª—
    ring.push(TARGETS.map(t=>smooth[t.key]));
    if(ring.length > WINDOW) ring.shift();
    const avg = Object.fromEntries(TARGETS.map((t,i)=>{
      const mean = ring.reduce((s,vec)=>s+vec[i], 0) / ring.length;
      return [t.key, mean];
    }));

    // æ›´æ–°æ¢
    TARGETS.forEach(t=>{
      const pct = (avg[t.key]*100).toFixed(1)+'%';
      const bar = document.getElementById('bar-'+t.key);
      if(bar){ bar.style.width = pct; bar.textContent = pct; }
    });

    // é‚Šéš›åˆ¤æ–·
    const sorted = TARGETS.map(t=>({key:t.key, v:avg[t.key]})).sort((a,b)=>b.v-a.v);
    const top1 = sorted[0], top2 = sorted[1];
    const marginOK = (top1.v - top2.v) >= MARGIN;

    // ç•¶å‰é¡¯ç¤º
    const topName = TARGETS.find(x=>x.key===top1.key)?.name || 'â€”';
    document.getElementById('currentMove').textContent = `${topName}ï¼ˆ${(top1.v*100).toFixed(0)}%ï¼‰`;

    if(marginOK){
      scoreTick(top1.key, top1.v);
    }else{
      if(currentKey === top1.key){ currentKey=null; holdStart=0; holdSum=0; holdFrames=0; }
    }
  }

  function scoreTick(topKey, conf){
    const threshold = Math.max(0.5, Math.min(0.95, parseFloat($('thres').value)||FALLBACK_THRESH));
    const minHoldMs = Math.max(500, Math.min(5000, (parseFloat($('hold').value)||2)*1000));
    const cooldownMs= Math.max(200, Math.min(3000, (parseFloat($('cool').value)||0.8)*1000));
    const now = performance.now();

    if(done[topKey]) return;
    if(now < cooldownUntil) return;
    if(conf < threshold){
      if(currentKey === topKey){ currentKey=null; holdStart=0; holdSum=0; holdFrames=0; }
      return;
    }

    if(currentKey !== topKey){
      currentKey = topKey; holdStart = now; holdSum=0; holdFrames=0;
    }
    holdSum += conf; holdFrames++;
    const held = now - holdStart;

    if(held >= minHoldMs){
      done[currentKey] = true;
      score[currentKey] = 100;
      document.getElementById('status-'+currentKey).textContent = 'âœ… å·²å®Œæˆ';
      document.getElementById('sc-'+currentKey).textContent = '100';
      flashRow(currentKey);
      recalcTotal();

      cooldownUntil = now + cooldownMs;
      currentKey=null; holdStart=0; holdSum=0; holdFrames=0;
    }
  }

  // é é¢è¼‰å…¥ï¼šå…ˆæŠŠæ¨¡å‹è¼‰å…¥ï¼ˆæ›´æ–°å³å´ç°å­—ï¼‰ï¼Œåˆ†æ•¸æ¸…ç©º
  try{
    await ensureModel();
    info('æ¨¡å‹å°±ç·’ï¼šæŒ‰ã€Œé–‹å§‹ç›¸æ©Ÿã€ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚', true);
  }catch(e){
    info('âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼š\n'+(e.message||e));
  }
})();
</script>
</body>
</html>
